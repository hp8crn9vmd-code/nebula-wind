---
import BaseLayout from "../../layouts/BaseLayout.astro";
---

<BaseLayout
  title="Search â€” NebulaWind"
  description="Search NebulaWind locally (offline-ready) using Pagefind."
>
  <main class="min-h-screen">
    <div class="max-w-3xl mx-auto px-5 py-16">
      <div class="flex items-end justify-between gap-4">
        <h1 class="text-4xl font-semibold tracking-tight">Search</h1>
        <a class="text-sm text-white/70 hover:text-white" href="/">Home</a>
      </div>

      <p class="mt-3 text-white/70">
        Local, offline-ready search powered by Pagefind.
      </p>

      <div class="mt-8">
        <input id="nw-q"
          class="w-full px-4 py-3 rounded-nw border border-white/10 bg-white/5 outline-none focus:border-white/20"
          type="search"
          placeholder="Search posts..."
          autocomplete="off" />
      </div>

      <div id="nw-results" class="mt-8 space-y-4"></div>

      <script is:inline src="/pagefind/pagefind.js"></script>

      <script is:inline>
        const input = document.getElementById("nw-q");
        const resultsEl = document.getElementById("nw-results");

        const escapeHtml = (s) =>
          String(s)
            .replaceAll("&","&amp;")
            .replaceAll("<","&lt;")
            .replaceAll(">","&gt;")
            .replaceAll('"',"&quot;")
            .replaceAll("'","&#039;");

        async function renderResults(query) {
          if (!resultsEl) return;
          if (!query) { resultsEl.innerHTML = ""; return; }

          const pf = window.pagefind;
          if (!pf) {
            resultsEl.innerHTML = "<p class='text-white/70'>Search index not loaded yet. Try again.</p>";
            return;
          }

          const search = await pf.search(query);
          const data = await Promise.all(search.results.slice(0, 10).map(r => r.data()));

          resultsEl.innerHTML = data.map(d => `
            <article class="p-5 rounded-nw border border-white/10 bg-white/5">
              <h2 class="text-lg font-semibold">
                <a class="hover:underline" href="${escapeHtml(d.url)}">${escapeHtml(d.meta?.title || d.url)}</a>
              </h2>
              ${d.excerpt ? `<p class="mt-2 text-white/75">${d.excerpt}</p>` : ""}
            </article>
          `).join("");
        }

        let t;
        input?.addEventListener("input", (e) => {
          const q = e.target?.value || "";
          clearTimeout(t);
          t = setTimeout(() => renderResults(q), 120);
        });
      </script>

      <div class="mt-12 text-sm text-white/60">
        Tip: run <code>npm run build</code> to regenerate the search index.
      </div>
    </div>
  </main>
</BaseLayout>
